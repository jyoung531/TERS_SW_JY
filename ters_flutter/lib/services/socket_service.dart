import 'package:web_socket_channel/web_socket_channel.dart';
import 'package:web_socket_channel/status.dart' as status;

class SocketService {
  // ------------------------------------------------------------------------
  // [1] ì„œë²„ ì£¼ì†Œ ì„¤ì • (WebSocketì€ http:// ëŒ€ì‹  ws:// ë¥¼ ì”ë‹ˆë‹¤)
  // ì•ˆë“œë¡œì´ë“œ ì—ë®¬ë ˆì´í„°: ws://10.0.2.2:8000
  // ì‹¤ì œ ê¸°ê¸°: ws://192.168.x.x:8000 (PC IP)
  //
  // *ì£¼ì˜*: '/ws/camera' ë¶€ë¶„ì€ Python ì„œë²„ì˜ ë¼ìš°í„° ì„¤ì •(@websocket)ê³¼ ë˜‘ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.
  // ì„ ë°°ë‹˜ ì½”ë“œë¥¼ í™•ì¸í•´ì„œ ì •í™•í•œ ê²½ë¡œ(End-point)ë¥¼ ì ì–´ì£¼ì„¸ìš”.
  // ------------------------------------------------------------------------
  static const String _wsUrl = 'ws://10.0.2.2:8000/ws/camera'; 

  WebSocketChannel? _channel;

  // ì—°ê²° ìƒíƒœ í™•ì¸ìš©
  bool get isConnected => _channel != null;

  // ------------------------------------------------------------------------
  // [2] ë°ì´í„° ìˆ˜ì‹  í†µë¡œ (Stream)
  // ìˆ˜ë„ê¼­ì§€ì²˜ëŸ¼ ë°ì´í„°ê°€ ì½¸ì½¸ ìŸì•„ì ¸ ë‚˜ì˜¤ëŠ” ê³³ì…ë‹ˆë‹¤.
  // Providerê°€ ì´ ìŠ¤íŠ¸ë¦¼ì„ êµ¬ë…(Listen)í•´ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ê°‘ë‹ˆë‹¤.
  // ------------------------------------------------------------------------
  Stream get stream {
    if (_channel == null) {
      // ì—°ê²°ì´ ì•ˆ ë˜ì–´ ìˆë‹¤ë©´ ë¹ˆ ìŠ¤íŠ¸ë¦¼ì„ ë°˜í™˜í•˜ê±°ë‚˜ ì—ëŸ¬ ì²˜ë¦¬
      return const Stream.empty();
    }
    return _channel!.stream;
  }

  // ------------------------------------------------------------------------
  // [3] ì—°ê²° ì‹œì‘ (Connect)
  // ì•±ì´ ì¼œì§€ê±°ë‚˜, ì¹´ë©”ë¼ í™”ë©´ì— ë“¤ì–´ê°ˆ ë•Œ í˜¸ì¶œí•©ë‹ˆë‹¤.
  // ------------------------------------------------------------------------
  void connect() {
    try {
      if (_channel != null) return; // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ íŒ¨ìŠ¤

      final uri = Uri.parse(_wsUrl);
      _channel = WebSocketChannel.connect(uri);
      print('ğŸ“¡ WebSocket ì—°ê²° ì‹œë„: $_wsUrl');
      
    } catch (e) {
      print('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: $e');
    }
  }

  // ------------------------------------------------------------------------
  // [4] ì—°ê²° ì¢…ë£Œ (Disconnect)
  // ì•±ì„ ë„ê±°ë‚˜ ë‹¤ë¥¸ í™”ë©´ìœ¼ë¡œ ê°ˆ ë•Œ ì—°ê²°ì„ ëŠì–´ì¤ë‹ˆë‹¤ (ë¦¬ì†ŒìŠ¤ ì ˆì•½).
  // ------------------------------------------------------------------------
  void disconnect() {
    if (_channel != null) {
      _channel!.sink.close(status.goingAway);
      _channel = null;
      print('ğŸ“´ WebSocket ì—°ê²° ì¢…ë£Œ');
    }
  }
}